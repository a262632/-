<!DOCTYPE />
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八日富士山與東京之旅 (V2.0)</title> 
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定字體 */
        html { font-family: 'Inter', sans-serif; }
        /* 主要容器：模擬手機視窗，固定高度，Flex Column 嚴格劃分區塊 */
        #app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 420px; /* 模擬手機最大寬度，居中顯示 */
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
            /* 移除可能導致滾動問題的溢出設定 */
            overflow: hidden; 
        }
        /* Header：固定在頂部 */
        #app-header {
            flex-shrink: 0; /* 不壓縮 */
            height: 64px;
        }
        /* Tab Bar：確保水平滾動順暢且隱藏滾動條 */
        #tab-bar {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; /* Firefox */
            flex-shrink: 0; /* 不壓縮 */
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        #tab-bar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* 內容區：佔用所有剩餘空間，可垂直滾動 */
        #app-content {
            overflow-y: auto;
            flex-grow: 1; /* 佔滿剩餘高度 */
            padding-bottom: 2rem;
            
        }
        /* Modal 進入動畫 */
        .modal-content-transition {
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- 導覽列/標頭 (固定在 Flex 容器頂部) -->
    <header id="app-header" class="w-full bg-white px-4 py-4 z-20 flex items-center justify-center">
        <h1 id="header-title" class="text-xl font-bold text-gray-800">八日富士山與東京之旅 (12/13-12/20)</h1>
    </header>

    <!-- 分頁導航欄 (在 Header 和內容之間，可左右滾動) -->
    <nav id="tab-bar" class="bg-white flex space-x-2 px-2 sm:px-4 z-10">
        <!-- Tab 按鈕將由 JavaScript 動態生成 -->
    </nav>

    <!-- 主要內容區 (行程詳情，佔滿剩餘空間並可上下滾動) -->
    <main id="app-content" class="p-4 bg-gray-50">
        <!-- 每日行程內容將由 JavaScript 動態插入 -->
        <div class="text-center p-8 text-gray-500">
            正在載入 Day 1 行程...
        </div>
    </main>
</div>

<!-- 行程詳情彈出視窗 (Modal) -->
<div id="activity-detail-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm modal-content-transition transform scale-95 opacity-0">
        <div class="p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-3 border-b pb-2">活動詳情</h3>
            <p id="modal-description" class="text-gray-700 leading-relaxed mb-6"></p>

            <!-- 點擊地圖按鈕 -->
            <button id="modal-map-button" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg mb-3">
                <span class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    在地圖上定位
                </span>
            </button>
            
            <!-- 關閉按鈕 -->
            <button onclick="closeModal()" class="w-full py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-colors">
                關閉
            </button>
        </div>
    </div>
</div>

<script>
    // 8天旅遊行程資料 (12/13 - 12/20) - **已恢復 Day 1 行程：住宿資訊與抵達分離 (V2.0)**
    const itineraryData = [
        {
            id: 'day1', day: 1, date: '12/13 (五)', location: '東京 (抵達/新宿)', theme: '抵達、機場快線與新宿 Check-in',
            map_query: '成田機場 新宿', 
            activities: [
                // 1. Arrival - 僅包含抵達時間與資訊
                { time: '19:20', name: '抵達成田機場 (NRT)', 
                  detail: '預計於此時間落地。建議事先查好前往新宿的路徑。', 
                  transportation: 'N/A', notes: 'N/A' 
                }, 
                { time: '20:30', name: '機場入境、購買交通票券', 
                  detail: '預留 1.5 - 2 小時用於入境手續與購票。', 
                  transportation: 'Narita Express (N\'EX) 或 Skyliner (轉 JR 山手線)', notes: 'N/A' 
                },
                // 3. Accommodation - 住宿備註獨立出來
                { time: '22:30', name: '抵達新宿，Check-in', 
                  detail: 'N/A', 
                  transportation: 'N/A', notes: '住宿：旅程前四晚住宿地點為新宿地區飯店' // 住宿資訊移至 Notes 欄位
                }
            ]
        },
        {
            id: 'day2', day: 2, date: '12/14 (六)', location: '東京/富士山 (河口湖)', theme: '從新宿前往河口湖、新倉富士淺間神社',
            map_query: '河口湖 新倉富士淺間神社',
            activities: [
                { time: '08:30', name: '前往新宿高速巴士總站', detail: '', transportation: '地鐵或步行', notes: '' },
                { time: '09:00', name: '搭乘高速巴士前往河口湖', detail: '需事先訂票！', transportation: '高速巴士 (Busta Shinjuku)', notes: '' },
                { time: '11:20', name: '抵達河口湖站、午餐 (餺飥)', detail: '午餐： 河口湖站周邊', transportation: 'N/A', notes: '' },
                { time: '13:00', name: '新倉富士淺間神社 (忠靈塔)', detail: '建議購買富士五湖周遊券', transportation: '富士急行線：河口湖站 → 下吉田站 (步行 15-20min 上山)', notes: '' },
                { time: '16:30', name: '下山，前往住宿地', detail: '', transportation: '富士急行線：下吉田站 → 富士山站 (步行或計程車)', notes: '住宿： The Noborisaka Village' }
            ]
        },
        {
            id: 'day3', day: 3, date: '12/15 (日)', location: '富士山 (忍野八海/山中湖)', theme: '忍野八海與山中湖周邊遊覽',
            map_query: '忍野八海 山中湖',
            activities: [
                { time: '09:00', name: '前往忍野八海', detail: '使用富士五湖周遊券', transportation: '富士急行巴士：富士山站 → 忍野八海入口', notes: '' },
                { time: '12:00', name: '忍野八海午餐與遊覽', detail: '', transportation: 'N/A', notes: '' },
                { time: '14:00', name: '前往山中湖', detail: '', transportation: '富士急行巴士：忍野八海入口 → 山中湖周邊', notes: '' },
                { time: '17:00', name: '返回住宿地', detail: '', transportation: '富士急行巴士：山中湖 → 富士山站', notes: '住宿： The Noborisaka Village' }
            ]
        },
        {
            id: 'day4', day: 4, date: '12/16 (一)', location: '富士山 (河口湖周遊)', theme: '西湖療癒之里、大石公園與音樂盒之森',
            map_query: '西湖療癒之里根場 大石公園',
            activities: [
                { time: '09:00', name: '西湖療癒之里根場', detail: '推薦一早前往', transportation: '富士急行線 → 河口湖站 → 西湖周遊巴士 (綠線)', notes: '' },
                { time: '11:30', name: '大石公園 (河口湖自然生活館)', detail: '', transportation: '河口湖站 → 河口湖周遊巴士 (紅線)', notes: '' },
                { time: '13:00', name: '午餐', detail: '', transportation: '紅線沿線餐廳', notes: '' },
                { time: '15:00', name: '音樂盒之森美術館', detail: '', transportation: '河口湖周遊巴士 (紅線)', notes: '' },
                { time: '17:00', name: '河口湖香草館', detail: '', transportation: '河口湖周遊巴士 (紅線)', notes: '' },
                { time: '18:30', name: '返回住宿地', detail: '', transportation: '河口湖站 → 富士急行線 → 富士山站', notes: '住宿： The Noborisaka Village' }
            ]
        },
        {
            id: 'day5', day: 5, date: '12/17 (二)', location: '富士山/東京 (移動日)', theme: '從富士山返回東京、六本木夜景',
            map_query: '富士山站 新宿 六本木',
            activities: [
                { time: '11:00', name: '退房、前往河口湖站', detail: '', transportation: '富士急行線：富士山站 → 河口湖站', notes: '' },
                { time: '12:00', name: '河口湖站午餐', detail: '', transportation: 'N/A', notes: '' },
                { time: '13:00', name: '搭乘高速巴士前往東京新宿', detail: '需事先訂票！', transportation: '高速巴士', notes: '' },
                { time: '15:00', name: '抵達新宿，Check-in', detail: '', transportation: '步行或地鐵', notes: '住宿： 東橫INN (新宿)' },
                { time: '17:00', name: '前往六本木', detail: '欣賞夜景與東京鐵塔', transportation: '都營大江戶線：新宿 → 六本木站', notes: '' },
                { time: '20:30', name: '六本木晚餐/夜景', detail: '', transportation: 'N/A', notes: '' }
            ]
        },
        {
            id: 'day6', day: 6, date: '12/18 (三)', location: '東京 (橫濱一日遊)', theme: '明治神宮與橫濱港未來區',
            map_query: '明治神宮 橫濱紅磚倉庫',
            activities: [
                { time: '09:00', name: '明治神宮', detail: '', transportation: 'JR 山手線：新宿 → 原宿站', notes: '' },
                { time: '11:00', name: '前往橫濱', detail: '', transportation: 'JR 湘南新宿線：新宿 → 櫻木町站 (直達)', notes: '' },
                { time: '12:00', name: '橫濱午餐 (港未來區/中華街)', detail: '', transportation: 'N/A', notes: '' },
                { time: '14:00', name: '橫濱紅磚倉庫', detail: '', transportation: '港灣未來線：櫻木町站 → 馬車道站/日本大通站', notes: '' },
                { time: '17:00', name: '橫濱港未來區', detail: '', transportation: '步行/港灣未來線', notes: '' },
                { time: '20:00', name: '返回新宿', detail: '', transportation: 'JR 湘南新宿線：橫濱站 → 新宿站', notes: '住宿： 東橫INN (新宿)' }
            ]
        },
        {
            id: 'day7', day: 7, date: '12/19 (四)', location: '東京 (澀谷/原宿/新宿)', theme: '潮流文化、逛街與最終採買',
            map_query: '澀谷 Scramble Square 原宿竹下通',
            activities: [
                { time: '10:00', name: '澀谷', detail: '澀谷交叉口、Scramble Square', transportation: 'JR 山手線：新宿 → 澀谷站', notes: '' },
                { time: '13:00', name: '澀谷午餐', detail: '', transportation: 'N/A', notes: '' },
                { time: '15:00', name: '原宿竹下通/表參道', detail: '', transportation: 'JR 山手線：澀谷 → 原宿站', notes: '' },
                { time: '17:00', name: '新宿逛街', detail: '進行最後採買', transportation: 'JR 山手線：原宿 → 新宿站', notes: '' },
                { time: '20:00', name: '新宿晚餐', detail: '', transportation: 'N/A', notes: '住宿： 東橫INN (新宿)' }
            ]
        },
        {
            id: 'day8', day: 8, date: '12/20 (五)', location: '東京 (返程)', theme: '退房與前往機場',
            map_query: '新宿 成田機場',
            activities: [
                { time: '08:30', name: '早餐、整理行李、退房', detail: '', transportation: 'N/A', notes: '' },
                { time: '09:00', name: '前往成田機場', detail: '預留充足交通時間', transportation: 'Narita Express (N\'EX) 或 利木津巴士', notes: '' },
                { time: '10:00', name: '抵達成田機場', detail: '', transportation: 'N/A', notes: '' },
                { time: '12:00', name: '飛機起飛', detail: '圓滿結束旅程', transportation: 'N/A', notes: '' }
            ]
        }
    ];

    // 定義相關的 JR/鐵路站名子集 (用於模擬下拉選單內容)
    const jrStations = [
        "未選擇",
        "新宿 (Shinjuku)",
        "東京 (Tokyo)",
        "品川 (Shinagawa)",
        "澀谷 (Shibuya)",
        "原宿 (Harajuku)",
        "上野 (Ueno)",
        "秋葉原 (Akihabara)",
        "鎌倉 (Kamakura)",
        "橫濱 (Yokohama)",
        "櫻木町 (Sakuragicho)",
        "馬車道 (Bashamichi) - 港灣未來線",
        "日本大通 (Nihon-ōdōri) - 港灣未來線",
        "河口湖 (Kawaguchiko) - 富士急行線",
        "富士山 (Fujisan) - 富士急行線",
        "下吉田 (Shimo-Yoshida) - 富士急行線",
        "大月 (Otsuki) - 轉乘點"
    ];

    // 獲取DOM元素
    const appContent = document.getElementById('app-content');
    const headerTitle = document.getElementById('header-title');
    const tabBar = document.getElementById('tab-bar');
    const modal = document.getElementById('activity-detail-modal');
    const modalContent = modal.querySelector('div.max-w-sm'); 

    // App狀態管理
    let currentState = {
        currentDayId: 'day1' // 預設從 Day 1 開始
    };
    
    // 交通方式選擇狀態 (key: dayId_index, value: selection)。
    let transportSelections = {};
    // 起始地點/站名選擇狀態 (儲存站名或自填文字)
    let fromStationSelections = {};
    // 目的地點/站名選擇狀態 (儲存站名或自填文字)
    let toStationSelections = {};
    // 起始自填時間狀態
    let fromTimeSelections = {};
    // 目的自填時間狀態
    let toTimeSelections = {};
    // 飛機班次自填狀態 (新增)
    let flightNumberSelections = {};

    // 將函數暴露給全局
    window.showDay = showDay;
    window.openMap = openMap;
    window.showActivityDetailModal = showActivityDetailModal;
    window.closeModal = closeModal;
    window.toggleTransportationSelector = toggleTransportationSelector;
    window.handleTransportationChange = handleTransportationChange;
    window.saveActivityInput = saveActivityInput; 
    window.renderStationSelectorsHtml = renderStationSelectorsHtml; // 暴露給 HTML 模板使用

    /**
     * 產生 HH:MM 格式的時間選項，間隔 30 分鐘，從 06:00 到 23:30
     * @returns {string[]} 時間字串陣列
     */
    function generateTimeOptions() {
        const times = [];
        // 從 06:00 開始到 23:30
        for (let h = 6; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                const hour = String(h).padStart(2, '0');
                const minute = String(m).padStart(2, '0');
                times.push(`${hour}:${minute}`);
            }
        }
        return times;
    }


    /**
     * 儲存起點或終點站的 地點/站名 或 自填時間。
     * @param {('from'|'to'|'N/A')} type - 選擇的類型 ('from', 'to', 或 'N/A' 給班次)
     * @param {('location'|'time'|'flightNumber')} field - 儲存的欄位類型
     * @param {string} value - 輸入值
     * @param {string} activityId - 活動的唯一 ID (dayX_indexY)
     */
    function saveActivityInput(type, field, value, activityId) {
        // 儲存原始字串，若為空字串或無效值則存為 '未選擇' 或 ''
        const safeValue = (value && value.trim() !== '' && value !== '未選擇') ? value.trim() : (field === 'location' ? '未選擇' : '');

        if (field === 'flightNumber') { // 處理班次儲存
            flightNumberSelections[activityId] = safeValue;
            return;
        }

        if (type === 'from') {
            if (field === 'location') fromStationSelections[activityId] = safeValue;
            if (field === 'time') fromTimeSelections[activityId] = safeValue;
        } else if (type === 'to') {
            if (field === 'location') toStationSelections[activityId] = safeValue;
            if (field === 'time') toTimeSelections[activityId] = safeValue;
        }
    }


    /**
     * Helper: 根據交通方式和站點類型，產生對應的 HTML 輸入元件 (下拉選單或文字輸入框 + 時間輸入)
     * 由於此函數在 renderDetailContent 被呼叫，必須確保它只返回 HTML 字串。
     * @param {('from'|'to')} type - 站點類型 ('from' 或 'to')
     * @param {string} currentStation - 當前儲存的站名或自填文字
     * @param {string} currentTime - 當前儲存的自填時間
     * @param {string} activityId - 活動的唯一 ID
     * @param {boolean} isJRorTrain - 是否為 JR 或火車
     * @returns {string} 產生的 HTML 碼
     */
    function getStationInputHtml(type, currentStation, currentTime, activityId, isJRorTrain) {
        // 根據 type 設定 '起點' 或 '終點' (用於地點標籤)
        const locationLabel = type === 'from' ? '起點' : '終點'; 
        // 根據 type 設定 '起點時間' 或 '終點時間' (用於時間標籤)
        const timeLabel = type === 'from' ? '起點時間 (HH:MM)' : '終點時間 (HH:MM)';

        const idLoc = type === 'from' ? `from-station-loc-${activityId}` : `to-station-loc-${activityId}`;
        const idTime = type === 'from' ? `from-station-time-${activityId}` : `to-station-time-${activityId}`;
        const name = type === 'from' ? 'from' : 'to';
        
        // 確保 currentStation 是字串，並處理 '未選擇' 狀態
        const safeCurrentStation = currentStation === '未選擇' ? '' : currentStation;
        // 確保 currentTime 是字串，並處理空狀態
        const safeCurrentTime = currentTime || '';

        let locationInputHtml;
        let titleClass;

        // JR/Train mode (Dropdown for Location)
        if (isJRorTrain) {
            titleClass = 'text-blue-600';
            const stationOptions = jrStations.map(station => 
                `<option value="${station}" ${safeCurrentStation === station ? 'selected' : ''}>${station}</option>`
            ).join('');
            
            locationInputHtml = `
                <div>
                    <label for="${idLoc}" class="block text-xs font-medium text-gray-500 mb-1">${locationLabel} (鐵路站點)</label>
                    <select id="${idLoc}" onchange="saveActivityInput('${name}', 'location', this.value, '${activityId}')"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 bg-white">
                        <option value="未選擇" disabled ${safeCurrentStation === '' ? 'selected' : ''}>-- 選擇站點 --</option>
                        ${stationOptions}
                    </select>
                </div>
            `;
        } 
        // Non-JR mode (Text Input for Location)
        else {
            titleClass = 'text-red-600';
            locationInputHtml = `
                <div>
                    <label for="${idLoc}" class="block text-xs font-medium text-gray-500 mb-1">${locationLabel} (自填)</label>
                    <input type="text" id="${idLoc}" value="${safeCurrentStation}" placeholder="請輸入起點/終點名稱"
                           onchange="saveActivityInput('${name}', 'location', this.value, '${activityId}')"
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 text-sm p-2 bg-white">
                </div>
            `;
        }
        
        // --- 時間輸入：改為下拉選單 (已修正標籤) ---
        const timeOptions = generateTimeOptions().map(time => 
            `<option value="${time}" ${safeCurrentTime === time ? 'selected' : ''}>${time}</option>`
        ).join('');
        
        const timeInputHtml = `
            <div>
                <label for="${idTime}" class="block text-xs font-medium text-gray-500 mb-1">${timeLabel}</label>
                <select id="${idTime}" onchange="saveActivityInput('${name}', 'time', this.value, '${activityId}')"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 text-sm p-2 bg-white">
                    <option value="" disabled ${safeCurrentTime === '' ? 'selected' : ''}>-- 選擇時間 --</option>
                    ${timeOptions}
                </select>
            </div>
        `;
        // --- 時間輸入結束 ---

        return `
            <div class="space-y-2">
                <p class="text-base font-bold ${titleClass} mb-2">${locationLabel}點</p>
                ${locationInputHtml}
                ${timeInputHtml}
            </div>
        `;
    }

    /**
     * 渲染或重新渲染站名選擇區塊
     * @param {string} activityId - 活動的唯一 ID
     * @param {string} currentTransportation - 當前選擇的交通方式 (新增參數)
     * @param {boolean} isJRorTrain - 是否為 JR 或火車
     */
    function renderStationSelectors(activityId, currentTransportation, isJRorTrain) {
        const stationSelectorsContainer = document.getElementById(`station-selectors-content-${activityId}`);
        if (!stationSelectorsContainer) return;

        const currentFromStation = fromStationSelections[activityId] || '未選擇';
        const currentToStation = toStationSelections[activityId] || '未選擇';
        const currentFromTime = fromTimeSelections[activityId] || '';
        const currentToTime = toTimeSelections[activityId] || '';
        const currentFlightNumber = flightNumberSelections[activityId] || ''; 
        
        stationSelectorsContainer.innerHTML = renderStationSelectorsHtml(
            activityId, 
            currentTransportation, // Pass transport selection
            isJRorTrain, 
            currentFromStation, currentToStation, 
            currentFromTime, currentToTime,
            currentFlightNumber 
        );
    }
    
    /**
     * 產生站點選擇器 HTML 字串，用於初始渲染和重新渲染。
     * @param {string} activityId - 活動的唯一 ID
     * @param {string} currentTransportation - 當前選擇的交通方式
     * @param {boolean} isJRorTrain - 是否為 JR 或火車
     * @param {string} currentFromStation - 當前儲存的起點
     * @param {string} currentToStation - 當前儲存的終點
     * @param {string} currentFromTime - 當前儲存的起點時間
     * @param {string} currentToTime - 當前儲存的終點時間
     * @param {string} currentFlightNumber - 當前儲存的航班號碼
     * @returns {string} 完整的 HTML 字串
     */
    function renderStationSelectorsHtml(activityId, currentTransportation, isJRorTrain, currentFromStation, currentToStation, currentFromTime, currentToTime, currentFlightNumber) {
        const isFlight = currentTransportation === '飛機';
        
        // 飛機模式：只顯示班次輸入
        if (isFlight) {
            return `
                <p class="text-sm font-semibold text-gray-700 mb-3">飛機班次資訊：</p>
                <div class="space-y-3">
                    <label for="flight-number-input-${activityId}" class="block text-xs font-medium text-gray-500 mb-1">班次 (自填)</label>
                    <input type="text" id="flight-number-input-${activityId}" value="${currentFlightNumber}" placeholder="請輸入航班號碼，例如: JX800"
                           onchange="saveActivityInput('N/A', 'flightNumber', this.value, '${activityId}')"
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 bg-white">
                </div>
            `;
        }

        // 非飛機模式 (原始邏輯)
        const headerText = isJRorTrain ? '鐵路站點規劃 (JR/火車/地鐵)' : '起點/終點站點規劃 (自填)';
        
        return `
            <p class="text-sm font-semibold text-gray-700 mb-3">${headerText}</p>
            <div class="grid grid-cols-2 gap-4">
                ${getStationInputHtml('from', currentFromStation, currentFromTime, activityId, isJRorTrain)}
                ${getStationInputHtml('to', currentToStation, currentToTime, activityId, isJRorTrain)}
            </div>
        `;
    }

    /**
     * 切換交通方式選擇器/下拉式選單的顯示狀態
     * @param {Event} event - 點擊事件
     * @param {string} activityId - 活動的唯一 ID (dayX_indexY)
     */
    function toggleTransportationSelector(event, activityId) {
        event.stopPropagation(); 
        
        const selector = document.getElementById(`transport-selector-${activityId}`);
        const arrow = document.getElementById(`transport-arrow-${activityId}`);

        if (selector.classList.contains('hidden')) {
            // 點擊開啟時，確保其他 selector 關閉 (手機上防止遮擋)
            document.querySelectorAll('.transport-selector-popup').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.transport-arrow').forEach(a => a.classList.remove('rotate-180'));

            selector.classList.remove('hidden');
            arrow.classList.add('rotate-180');
        } else {
            selector.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    }

    /**
     * 儲存交通方式的選擇並更新顯示，同時處理站點選擇器的內容切換。
     * @param {string} value - 選定的交通方式 (e.g., 'JR', '計程車')
     * @param {string} activityId - 活動的唯一 ID (dayX_indexY)
     */
    function handleTransportationChange(value, activityId) {
        // 1. 更新主要交通方式狀態
        transportSelections[activityId] = value;
        const selectedSpan = document.getElementById(`transport-selected-${activityId}`);
        const selectorContainer = document.getElementById(`transport-selector-${activityId}`);
        
        const isJRorTrain = (value.includes('JR') || value.includes('火車') || value.includes('線') || value.includes('地鐵') || value.includes('快線'));

        if (selectedSpan) {
            const displayValue = value || '未選擇';
            selectedSpan.textContent = displayValue;
            
            selectedSpan.classList.remove('text-red-500', 'text-green-600');
            selectedSpan.classList.add(displayValue === '未選擇' ? 'text-red-500' : 'text-green-600');

            // 選擇後自動關閉下拉選單
            selectorContainer.classList.add('hidden');
            document.getElementById(`transport-arrow-${activityId}`).classList.remove('rotate-180');
        }
        
        // 2. 重新渲染站點選擇區塊以切換輸入模式 (Dropdown <-> Text Input 或 班次輸入)
        renderStationSelectors(activityId, value, isJRorTrain); // 傳遞 value (currentTransportation)
    }

    /**
     * 渲染頂部標籤列 (確保有足夠的內容和樣式)
     */
    function renderTabs() {
        const tabHtml = itineraryData.map(item => `
            <button id="tab-${item.id}"
                class="tab-button flex-shrink-0 px-4 py-3 text-sm font-semibold transition-colors duration-200 border-b-2 whitespace-nowrap
                       ${item.id === currentState.currentDayId ? 'text-indigo-600 border-indigo-600 bg-gray-50' : 'text-gray-500 border-transparent hover:text-indigo-500 hover:bg-gray-100'}"
                onclick="showDay('${item.id}')">
                DAY ${item.day} (${item.date.split(' ')[0]})
            </button>
        `).join('');

        tabBar.innerHTML = `<div class="flex">${tabHtml}</div>`;
    }

    /**
     * 導航並顯示特定日期的行程
     * @param {string} id - 目的地的 ID (如 day1, day2)
     */
    function showDay(id) {
        const item = itineraryData.find(d => d.id === id);
        if (!item) return;

        currentState.currentDayId = id;

        // 1. 更新標籤樣式
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('text-indigo-600', 'border-indigo-600', 'bg-gray-50');
            btn.classList.add('text-gray-500', 'border-transparent', 'hover:text-indigo-500', 'hover:bg-gray-100');
        });
        const activeTab = document.getElementById(`tab-${id}`);
        if (activeTab) {
            activeTab.classList.add('text-indigo-600', 'border-indigo-600', 'bg-gray-50');
            activeTab.classList.remove('text-gray-500', 'border-transparent', 'hover:text-indigo-500', 'hover:bg-gray-100');
            // 確保選中的標籤在可見範圍內
            activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
        
        // 2. 更新頭部標題
        headerTitle.textContent = `八日富士山與東京之旅 - Day ${item.day}`;
        
        // 3. 渲染內容
        renderDetailContent(item);
        
        // 4. 滾動到內容頂部
        appContent.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    /**
     * 渲染單一目的地的詳細內容 (已新增交通方式選擇器)
     * @param {object} item - 行程物件
     */
    function renderDetailContent(item) {
        const activitiesList = item.activities.map((activity, index) => { // 取得 index 作為唯一 ID 的一部分
            // 為了 JS 函數調用，對引號進行轉義
            const nameEscaped = activity.name.replace(/'/g, "\\'");
            // 嘗試從活動名稱或詳細資訊中提取一個合理的 Google 地圖查詢
            const mapQuery = activity.name + (activity.transportation ? ` ${activity.transportation}` : '');
            const mapQueryEscaped = mapQuery.replace(/'/g, "\\'");
            
            // 詳情文字：如果 time 不是有效的時間（如：'住宿'），則使用 detail 作為描述。
            const detailText = (activity.detail || activity.notes || activity.transportation || activity.name || '無詳細說明').replace(/\n/g, '<br>');
            const detailEscaped = detailText.replace(/'/g, "\\'");
            
            const activityId = `${item.id}_${index}`; // 建立活動的唯一 ID
            
            // 獲取當前選擇狀態
            // 預設交通方式為表格中的值
            if (!transportSelections[activityId]) {
                 // 嘗試從表格的 transportation 欄位中提取交通方式作為預設值
                if (activity.transportation && activity.transportation !== 'N/A') {
                    transportSelections[activityId] = activity.transportation.split(':')[0].trim(); // 例如只取 "JR 山手線"
                } else {
                    transportSelections[activityId] = 'N/A';
                }
            }
            const currentSelection = transportSelections[activityId];

            // 預設起點/終點時間為表格中的 time 欄位
            if (!fromTimeSelections[activityId]) {
                fromTimeSelections[activityId] = activity.time || '';
            }

            const currentFromStation = fromStationSelections[activityId] || '未選擇';
            const currentToStation = toStationSelections[activityId] || '未選擇';
            const currentFromTime = fromTimeSelections[activityId] || ''; 
            const currentToTime = toTimeSelections[activityId] || '';     
            
            const isJRorTrain = (currentSelection.includes('JR') || currentSelection.includes('火車') || currentSelection.includes('線') || currentSelection.includes('地鐵') || currentSelection.includes('快線'));
            const currentFlightNumber = flightNumberSelections[activityId] || ''; // Retrieve flight number
            
            // 建立交通方式下拉選單選項 HTML (新增飛機)
            const transportOptions = [
                { value: "飛機", label: "飛機 (Airplane)" },
                { value: "計程車", label: "計程車 (Taxi)" },
                { value: "巴士/高速巴士", label: "巴士/高速巴士" },
                { value: "JR", label: "JR (火車/N'EX)" },
                { value: "地鐵/私鐵", label: "地鐵/私鐵 (線)" },
                { value: "步行", label: "步行" },
                { value: "N/A", label: "不適用 (N/A)" }
            ].map(opt => `<button onclick="handleTransportationChange('${opt.value}', '${activityId}'); toggleTransportationSelector(event, '${activityId}');" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">${opt.label}</button>`).join('');

            // 處理時間顯示，如果不是有效的時間，則使用不同的樣式
            const isInfoOnly = activity.time.length > 5 || isNaN(new Date('1970/01/01 ' + activity.time));
            const timeClass = isInfoOnly ? 'text-sm font-semibold text-gray-500 italic' : 'text-lg font-bold text-indigo-600';
            const timeDisplay = isInfoOnly ? activity.time : activity.time;
            
            // 隱藏交通細節規劃區塊：如果 transportation 是 'N/A' 則隱藏
            const hideTransportationDetail = (activity.transportation === 'N/A');
            const transportationDetailClass = hideTransportationDetail ? 'hidden' : '';


            return `
                <li class="mb-3 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                    <!-- 主要活動資訊區塊 - 點擊開啟詳情 Modal -->
                    <div class="flex items-start cursor-pointer hover:bg-gray-50 transition-colors -m-4 p-4 pb-2 rounded-xl"
                        onclick="showActivityDetailModal(
                            '${nameEscaped}', 
                            '${detailEscaped}', 
                            '${mapQueryEscaped}'
                        )">
                        <div class="flex-shrink-0 mr-4 mt-1">
                            <span class="${timeClass}">${timeDisplay}</span>
                        </div>
                        <div class="flex-grow">
                            <p class="text-base font-semibold text-gray-900">${activity.name}</p>
                            <!-- 顯示表格中的備註和交通工具 -->
                            <p class="text-sm text-gray-500 mt-1">
                                ${activity.notes && activity.notes !== 'N/A' ? `<span class="font-bold text-yellow-600">${activity.notes}</span> - ` : ''} 
                                ${activity.transportation && activity.transportation !== 'N/A' ? `交通：${activity.transportation}` : '無交通資訊'}
                            </p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mt-2 ml-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                    
                    <!-- 交通方式選擇器/切換按鈕 -->
                    <div class="mt-4 pt-4 border-t border-gray-200 relative ${transportationDetailClass}" onclick="event.stopPropagation()">
                        <button class="w-full text-left flex justify-between items-center text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors p-2 rounded-lg bg-gray-50 hover:bg-gray-100"
                                onclick="toggleTransportationSelector(event, '${activityId}')">
                            <!-- 更改標籤為「交通選擇」 -->
                            <span>交通選擇：<span id="transport-selected-${activityId}" class="font-extrabold ${currentSelection === '未選擇' || currentSelection === 'N/A' ? 'text-red-500' : 'text-green-600'}">${currentSelection}</span></span>
                            <svg id="transport-arrow-${activityId}" class="transport-arrow w-4 h-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        
                        <!-- 交通方式下拉選單容器 (使用絕對定位模擬 Popup) -->
                        <div id="transport-selector-${activityId}" class="transport-selector-popup absolute right-0 mt-1 w-40 bg-white border border-gray-200 rounded-lg shadow-xl z-30 hidden overflow-hidden flex flex-col">
                            ${transportOptions}
                        </div>
                    </div>

                    <!-- 站名選擇區塊 (交通細節規劃) -->
                    <div id="station-selectors-${activityId}" class="mt-4 pt-3 border-t border-gray-200 ${transportationDetailClass}">
                        <p class="text-sm font-semibold text-gray-700 mb-2">交通細節規劃：</p>
                        <div id="station-selectors-content-${activityId}">
                            <!-- 初始渲染時調用 renderStationSelectorsHtml 填充內容 -->
                            ${renderStationSelectorsHtml(activityId, currentSelection, isJRorTrain, currentFromStation, currentToStation, currentFromTime, currentToTime, currentFlightNumber)}
                        </div>
                    </div>
                </li>
            `;
        }).join('');

        // 渲染詳細內容
        appContent.innerHTML = `
            <div class="bg-gray-50 rounded-xl shadow-lg p-6">
                
                <p class="text-sm font-bold text-red-500">當日：${item.date} (${item.location})</p>
                <h2 class="text-2xl font-bold text-gray-900 mb-4 mt-1">${item.theme}</h2>
                

                <!-- 每日行程清單 -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-gray-800">當日時間表與活動</h3>
                    <ul class="list-none p-0 m-0 space-y-3">${activitiesList}</ul>
                </div>

                <!-- 互動按鈕 -->
                <div class="mt-8 flex flex-col space-y-3">
                    <button class="w-full py-3 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition-colors shadow-lg"
                            onclick="openMap('${item.map_query}')">
                        <span class="flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                            總覽地圖查詢「${item.map_query}」
                        </span>
                    </button>
                </div>
            </div>
        `;
    }

    /**
     * 顯示活動詳情的彈出視窗 (Modal)
     */
    function showActivityDetailModal(name, description, mapQuery) {
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalMapButton = document.getElementById('modal-map-button');

        modalTitle.textContent = name;
        // 替換換行符號為 <br>
        modalDescription.innerHTML = description.replace(/\n/g, '<br>'); 
        
        modalMapButton.onclick = () => {
            openMap(mapQuery);
            closeModal();
        };
        modalMapButton.querySelector('span').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                </svg>在地圖上定位「${mapQuery}」`;


        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 10);

        modal.onclick = (e) => {
            if (e.target.id === 'activity-detail-modal') {
                closeModal();
            }
        };
    }

    /**
     * 關閉活動詳情的彈出視窗 (Modal)
     */
    function closeModal() {
        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
    
    /**
     * 開啟 Google Map 連結並查詢特定地點
     */
    function openMap(query) {
        const encodedQuery = encodeURIComponent(query);
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedQuery}`;
        
        window.open(mapUrl, '_blank');
    }


    /**
     * App 初始化函數
     */
    function initializeApp() {
        renderTabs();
        showDay('day1');
    }

    // 初始化 App
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });
</script>

</body>
</html>
